<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ColdFusion Peggy 解析器</title>
  <script src="https://cdn.jsdelivr.net/npm/peggy@4.0.3/browser/peggy.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #333;
      border-bottom: 3px solid #007bff;
      padding-bottom: 10px;
    }
    .info-badge {
      display: inline-block;
      background: #28a745;
      color: white;
      padding: 5px 12px;
      border-radius: 12px;
      font-size: 14px;
      margin-left: 10px;
    }
    .note {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
      border-left: 4px solid #2196f3;
    }
    .container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }
    .panel {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .panel h2 {
      margin-top: 0;
      color: #007bff;
      font-size: 18px;
    }
    textarea {
      width: 100%;
      height: 400px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      resize: vertical;
      box-sizing: border-box;
    }
    pre {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      max-height: 400px;
      overflow-y: auto;
      font-size: 13px;
      line-height: 1.5;
      margin: 0;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
    }
    button:hover {
      background: #0056b3;
    }
    .error {
      color: #dc3545;
      background: #f8d7da;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 10px;
      white-space: pre-wrap;
    }
    .success {
      color: #28a745;
      background: #d4edda;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    .examples {
      margin-top: 20px;
    }
    .example-btn {
      background: #6c757d;
      margin-right: 10px;
      margin-bottom: 10px;
      padding: 8px 15px;
      font-size: 14px;
    }
    .example-btn:hover {
      background: #5a6268;
    }
    #status {
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 20px;
      display: none;
    }
    #status.loading {
      display: block;
      background: #fff3cd;
      color: #856404;
    }
    #status.ready {
      display: block;
      background: #d4edda;
      color: #155724;
    }
    #status.error {
      display: block;
      background: #f8d7da;
      color: #721c24;
    }
  </style>
</head>
<body>
  <h1>🚀 ColdFusion Peggy 解析器 <span class="info-badge">Peggy 4.0.3</span></h1>
  
  <div class="note">
    <strong>💡 使用 Peggy (PEG.js 的现代继任者)</strong><br>
    Peggy 是 PEG.js 的活跃维护版本，提供更好的性能、TypeScript 支持和错误提示。完全兼容 PEG.js 语法。
  </div>
  
  <div id="status" class="loading">正在初始化解析器...</div>
  
  <div class="examples">
    <strong>示例代码：</strong><br>
    <button class="example-btn" onclick="loadExample(1)">示例 1: cfset & cfoutput</button>
    <button class="example-btn" onclick="loadExample(2)">示例 2: cfif 条件</button>
    <button class="example-btn" onclick="loadExample(3)">示例 3: cfloop 循环</button>
    <button class="example-btn" onclick="loadExample(4)">示例 4: cfscript</button>
    <button class="example-btn" onclick="loadExample(5)">示例 5: 复杂嵌套</button>
  </div>

  <div class="container">
    <div class="panel">
      <h2>📝 ColdFusion 代码</h2>
      <textarea id="input"></textarea>
      <button onclick="parseCode()">解析生成 AST</button>
    </div>
    
    <div class="panel">
      <h2>🌳 生成的 AST</h2>
      <pre id="output">点击"解析生成 AST"按钮查看结果...</pre>
    </div>
  </div>

  <script>
    const grammar = `
{
  function buildBinaryExpression(head, tail) {
    return tail.reduce((result, element) => {
      return {
        type: 'BinaryExpression',
        operator: element[1],
        left: result,
        right: element[3]
      };
    }, head);
  }
}

Program
  = _ statements:Statement* _ {
      return {
        type: 'Program',
        body: statements
      };
    }

Statement
  = CFSetStatement
  / CFIfStatement
  / CFLoopStatement
  / CFOutputStatement
  / CFScriptBlock

CFSetStatement
  = "<cfset"i _ name:Identifier _ "=" _ value:Expression _ ">" _ {
      return {
        type: 'CFSetStatement',
        variable: name,
        value: value
      };
    }

CFIfStatement
  = "<cfif"i _ condition:Expression _ ">" _
    consequent:Statement* _
    alternate:CFElseClause? _
    "</cfif"i _ ">" _ {
      return {
        type: 'CFIfStatement',
        condition: condition,
        consequent: consequent,
        alternate: alternate
      };
    }

CFElseClause
  = "<cfelse"i _ ">" _ body:Statement* {
      return body;
    }
  / "<cfelseif"i _ condition:Expression _ ">" _
    consequent:Statement* _
    alternate:CFElseClause? {
      return [{
        type: 'CFIfStatement',
        condition: condition,
        consequent: consequent,
        alternate: alternate
      }];
    }

CFLoopStatement
  = "<cfloop"i _ attrs:LoopAttributes _ ">" _
    body:Statement* _
    "</cfloop"i _ ">" _ {
      return {
        type: 'CFLoopStatement',
        attributes: attrs,
        body: body
      };
    }

LoopAttributes
  = head:LoopAttribute tail:(_ LoopAttribute)* {
      return [head, ...tail.map(t => t[1])];
    }

LoopAttribute
  = name:Identifier _ "=" _ value:AttributeValue {
      return { name: name.name, value: value };
    }

CFOutputStatement
  = "<cfoutput"i _ ">" _
    content:OutputContent* _
    "</cfoutput"i _ ">" _ {
      return {
        type: 'CFOutputStatement',
        content: content
      };
    }

OutputContent
  = CFExpression
  / TextContent

CFExpression
  = "#" expr:Expression "#" {
      return {
        type: 'CFExpression',
        expression: expr
      };
    }

TextContent
  = chars:(!("</" / "#") .)+ {
      return {
        type: 'TextContent',
        value: chars.map(c => c[1]).join('')
      };
    }

CFScriptBlock
  = "<cfscript"i _ ">" _
    body:ScriptStatement* _
    "</cfscript"i _ ">" _ {
      return {
        type: 'CFScriptBlock',
        body: body
      };
    }

ScriptStatement
  = _ stmt:(
      VarDeclaration
      / FunctionDeclaration
      / ReturnStatement
      / ExpressionStatement
    ) _ ";"? _ {
      return stmt;
    }

VarDeclaration
  = "var"i _ name:Identifier _ "=" _ value:Expression {
      return {
        type: 'VariableDeclaration',
        variable: name,
        value: value
      };
    }

FunctionDeclaration
  = "function"i _ name:Identifier _ "(" _ params:ParameterList? _ ")" _ "{" _
    body:ScriptStatement* _
    "}" {
      return {
        type: 'FunctionDeclaration',
        name: name,
        parameters: params || [],
        body: body
      };
    }

ParameterList
  = head:Identifier tail:(_ "," _ Identifier)* {
      return [head, ...tail.map(t => t[3])];
    }

ReturnStatement
  = "return"i _ value:Expression? {
      return {
        type: 'ReturnStatement',
        value: value
      };
    }

ExpressionStatement
  = expr:Expression {
      return {
        type: 'ExpressionStatement',
        expression: expr
      };
    }

Expression
  = AdditiveExpression

AdditiveExpression
  = head:MultiplicativeExpression
    tail:(_ ("+" / "-") _ MultiplicativeExpression)* {
      return buildBinaryExpression(head, tail);
    }

MultiplicativeExpression
  = head:ComparisonExpression
    tail:(_ ("*" / "/") _ ComparisonExpression)* {
      return buildBinaryExpression(head, tail);
    }

ComparisonExpression
  = head:PrimaryExpression
    tail:(_ ("==" / "!=" / "<=" / ">=" / "<" / ">" / "GT"i / "LT"i / "EQ"i / "NEQ"i / "GTE"i / "LTE"i) _ PrimaryExpression)* {
      return buildBinaryExpression(head, tail);
    }

PrimaryExpression
  = FunctionCall
  / Identifier
  / StringLiteral
  / NumberLiteral
  / BooleanLiteral
  / "(" _ expr:Expression _ ")" { return expr; }

FunctionCall
  = name:Identifier _ "(" _ args:ArgumentList? _ ")" {
      return {
        type: 'FunctionCall',
        name: name,
        arguments: args || []
      };
    }

ArgumentList
  = head:Expression tail:(_ "," _ Expression)* {
      return [head, ...tail.map(t => t[3])];
    }

Identifier
  = !ReservedWord [a-zA-Z_][a-zA-Z0-9_]* {
      return {
        type: 'Identifier',
        name: text()
      };
    }

StringLiteral
  = '"' chars:DoubleStringCharacter* '"' {
      return {
        type: 'StringLiteral',
        value: chars.join('')
      };
    }
  / "'" chars:SingleStringCharacter* "'" {
      return {
        type: 'StringLiteral',
        value: chars.join('')
      };
    }

DoubleStringCharacter
  = !('"' / "\\\\") char:. { return char; }
  / "\\\\" sequence:EscapeSequence { return sequence; }

SingleStringCharacter
  = !("'" / "\\\\") char:. { return char; }
  / "\\\\" sequence:EscapeSequence { return sequence; }

EscapeSequence
  = "'"
  / '"'
  / "\\\\"
  / "n" { return "\\n"; }
  / "r" { return "\\r"; }
  / "t" { return "\\t"; }

NumberLiteral
  = [0-9]+ ("." [0-9]+)? {
      return {
        type: 'NumberLiteral',
        value: parseFloat(text())
      };
    }

BooleanLiteral
  = "true"i {
      return {
        type: 'BooleanLiteral',
        value: true
      };
    }
  / "false"i {
      return {
        type: 'BooleanLiteral',
        value: false
      };
    }

AttributeValue
  = StringLiteral
  / NumberLiteral
  / Identifier

ReservedWord
  = ("var"i / "function"i / "return"i / "if"i / "else"i) ![a-zA-Z0-9_]

_
  = [ \\t\\n\\r]*
`;

    let parser;
    
    function initParser() {
      const status = document.getElementById('status');
      try {
        // Peggy 使用 peggy.generate() 方法
        parser = peggy.generate(grammar);
        status.textContent = '✓ 解析器初始化成功！使用 Peggy ' + peggy.VERSION;
        status.className = 'ready';
        setTimeout(() => {
          status.style.display = 'none';
        }, 3000);
      } catch (e) {
        status.textContent = '✗ 解析器初始化失败：' + e.message;
        status.className = 'error';
        console.error('语法错误:', e);
      }
    }

    const examples = {
      1: `<cfset userName = "张三">
<cfset userAge = 25>
<cfoutput>
  用户名：#userName#，年龄：#userAge#
</cfoutput>`,
      2: `<cfset score = 85>
<cfif score GT 90>
  <cfset grade = "优秀">
<cfelse>
  <cfset grade = "良好">
</cfif>`,
      3: `<cfloop index="i" from="1" to="5">
  <cfset result = i * 2>
</cfloop>`,
      4: `<cfscript>
  var x = 10;
  var y = 20;
  
  function add(a, b) {
    return a + b;
  }
  
  var sum = add(x, y);
</cfscript>`,
      5: `<cfset total = 0>
<cfloop index="i" from="1" to="10">
  <cfif i GT 5>
    <cfset total = total + i>
    <cfoutput>当前i=#i#, total=#total#</cfoutput>
  </cfif>
</cfloop>`
    };

    function loadExample(num) {
      document.getElementById('input').value = examples[num];
    }

    function parseCode() {
      const input = document.getElementById('input').value;
      const output = document.getElementById('output');
      
      if (!parser) {
        output.innerHTML = '<div class="error">解析器未初始化</div>';
        return;
      }
      
      if (!input.trim()) {
        output.innerHTML = '<div class="error">请输入 ColdFusion 代码</div>';
        return;
      }
      
      try {
        const ast = parser.parse(input);
        output.innerHTML = '<div class="success">✓ 解析成功！</div>' + 
                          JSON.stringify(ast, null, 2);
      } catch (e) {
        let errorMsg = '✗ 解析错误：\n' + e.message;
        if (e.location) {
          errorMsg += '\n\n位置：第 ' + e.location.start.line + 
                     ' 行，第 ' + e.location.start.column + ' 列';
          
          // 显示出错的代码片段
          const lines = input.split('\n');
          const errorLine = lines[e.location.start.line - 1];
          if (errorLine) {
            errorMsg += '\n\n出错代码：\n' + errorLine;
            errorMsg += '\n' + ' '.repeat(e.location.start.column - 1) + '^';
          }
        }
        output.innerHTML = '<div class="error">' + errorMsg + '</div>';
      }
    }

    // 页面加载后初始化
    window.onload = function() {
      initParser();
      loadExample(1);
    };
  </script>
</body>
</html>